name: macOS Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: write

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install dependencies
      run: |
        brew update
        brew install cmake rubberband

    - name: Clone AudioUnitSDK
      run: git clone https://github.com/apple/AudioUnitSDK.git

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INCLUDE_PATH="${GITHUB_WORKSPACE}/AudioUnitSDK/include" ..

    - name: Build
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu)

    - name: Prepare AU Component for Signing
      run: |
        mkdir -p build/Release
        find build -name "PolyphonicPitchShifter.component" -exec cp -R {} build/Release/ \;

    - name: Ad-hoc Code Sign AU Component
      run: |
        codesign --force --deep --sign - build/Release/PolyphonicPitchShifter.component

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AudioUnitComponent
        path: build/Release/PolyphonicPitchShifter.component
        if-no-files-found: error
